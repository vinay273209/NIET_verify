<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Student QR Verification</title>

    <!-- Bootstrap 5 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- QR Scanner -->
    <script src="https://unpkg.com/html5-qrcode"></script>
</head>

<body class="bg-light">

<div class="container py-5">
    <div class="row justify-content-center">
        <div class="col-md-6">

            <!-- Card -->
            <div class="card shadow-lg">
                <div class="card-header text-center bg-primary text-white">
                    <h4>Student QR Verification System</h4>
                </div>

                <div class="card-body text-center">

                    <!-- QR Reader -->
                    <div id="reader" class="mb-3"></div>

                    <!-- Result -->
                    <div id="result"></div>

                    <!-- Verify Another Button -->
                    <button id="verifyAnotherBtn"
                            class="btn btn-secondary mt-3 d-none"
                            onclick="startScanner()">
                        Verify Another
                    </button>
                </div>
            </div>

        </div>
    </div>
</div>

<script>
let html5QrCode;

function startScanner() {
    document.getElementById("result").innerHTML = "";
    document.getElementById("verifyAnotherBtn").classList.add("d-none");

    html5QrCode = new Html5Qrcode("reader");
    html5QrCode.start(
        { facingMode: "environment" },
        { fps: 10, qrbox: 250 },
        onScanSuccess
    );
}

function stopScanner() {
    if (html5QrCode) {
        html5QrCode.stop().then(() => {
            document.getElementById("reader").innerHTML = "";
        });
    }
}

function onScanSuccess(decodedText) {
    stopScanner();

    fetch("/verify", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ uuid: decodedText })
    })
    .then(res => res.json())
    .then(data => {

        if (data.status === "invalid") {
            document.getElementById("result").innerHTML = `
                <div class="alert alert-danger fw-bold fs-4">
                    ❌ INVALID STUDENT
                </div>
            `;
        }
        else if (data.already_verified) {
            document.getElementById("result").innerHTML = `
                <div class="alert alert-dark fw-bold fs-3">
                    ⚠️ ALREADY VERIFIED
                </div>
                <div class="alert alert-secondary">
                    <strong>Time:</strong> ${data.time}
                </div>
            `;
        }
        else {
            document.getElementById("result").innerHTML = `
                <div class="alert alert-success fw-bold fs-4">
                    ✅ VERIFIED SUCCESSFULLY
                </div>

                <ul class="list-group text-start">
                    <li class="list-group-item"><strong>Name:</strong> ${data.name}</li>
                    <li class="list-group-item"><strong>Email:</strong> ${data.email}</li>
                    <li class="list-group-item"><strong>Branch:</strong> ${data.branch}</li>
                    <li class="list-group-item"><strong>UUID:</strong> ${data.uuid}</li>
                    <li class="list-group-item"><strong>Time:</strong> ${data.time}</li>
                </ul>
            `;
        }

        document.getElementById("verifyAnotherBtn").classList.remove("d-none");
    });
}

// Start scanner on load
startScanner();
</script>

</body>
</html>
