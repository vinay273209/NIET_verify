<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Admin Panel - QR Verification</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- Bootstrap 5 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

    <style>
        body {
            background: #f4f6f8;
        }
        .card {
            margin-bottom: 20px;
        }
        .key-badge {
            font-size: 1rem;
            letter-spacing: 1px;
        }
    </style>
</head>
<body>

<div class="container mt-4">

    <h3 class="text-center mb-4">üîê Admin Panel</h3>

    <!-- Admin Secret -->
    <div class="card">
        <div class="card-body">
            <h5 class="card-title">Admin Authentication</h5>
            <input type="password" id="adminSecret" class="form-control" placeholder="Enter Admin Secret">
        </div>
    </div>

    <!-- Generate Key -->
    <div class="card">
        <div class="card-body">
            <h5 class="card-title">Generate Volunteer Pass Key</h5>
            <div class="row g-2">
                <div class="col-md-8">
                    <input type="text" id="erpId" class="form-control" placeholder="Enter ERP ID">
                </div>
                <div class="col-md-4">
                    <button class="btn btn-primary w-100" onclick="generateKey()">Generate</button>
                </div>
            </div>

            <div id="generatedKey" class="alert alert-success mt-3 d-none"></div>
        </div>
    </div>

    <!-- Show Keys Button -->
    <div class="card">
        <div class="card-body text-center">
            <button class="btn btn-warning" onclick="verifyAndShowKeys()">
                üîç Show All Pass Keys
            </button>
            <p class="text-muted mt-2 mb-0">
                (Admin secret required)
            </p>
        </div>
    </div>

    <!-- Pass Keys Table -->
    <div class="card d-none" id="keysCard">
        <div class="card-body">
            <h5 class="card-title">Volunteer Pass Keys</h5>

            <div class="table-responsive">
                <table class="table table-bordered table-striped" id="keysTable">
                    <thead class="table-dark">
                        <tr>
                            <th>ERP ID</th>
                            <th>Pass Key</th>
                            <th>Status</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Filled dynamically -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Stats -->
    <div class="card">
        <div class="card-body">
            <h5 class="card-title">Verification Status</h5>
            <button class="btn btn-secondary mb-3" onclick="loadStats()">Refresh</button>

            <ul class="list-group">
                <li class="list-group-item">üë• Total Students: <span id="total">-</span></li>
                <li class="list-group-item">‚úÖ Verified: <span id="verified">-</span></li>
                <li class="list-group-item">‚ùå Unverified: <span id="unverified">-</span></li>
            </ul>
        </div>
    </div>

</div>

<script>
/* ================= VERIFY ADMIN & SHOW KEYS ================= */
async function verifyAndShowKeys() {
    const secret = document.getElementById("adminSecret").value;
    if (!secret) {
        alert("Enter admin secret first");
        return;
    }

    const res = await fetch("/admin/keys", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ admin_secret: secret })
    });

    const data = await res.json();
    if (data.status !== "success") {
        alert("Invalid admin secret");
        return;
    }

    document.getElementById("keysCard").classList.remove("d-none");
    renderTable(data.keys);
}

/* ================= GENERATE KEY ================= */
async function generateKey() {
    const secret = document.getElementById("adminSecret").value;
    const erp = document.getElementById("erpId").value.trim();

    if (!erp) {
        alert("ERP ID required");
        return;
    }

    const res = await fetch("/admin/generate-key", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
            admin_secret: secret,
            erp_id: erp
        })
    });

    const data = await res.json();

    if (data.status === "success") {
        document.getElementById("generatedKey").classList.remove("d-none");
        document.getElementById("generatedKey").innerHTML =
            `Pass Key for <b>${data.erp_id}</b>: 
             <span class="badge bg-success key-badge">${data.pass_key}</span>`;

        verifyAndShowKeys(); // refresh table
    } else {
        alert("Unauthorized or error");
    }
}

/* ================= RENDER TABLE ================= */
function renderTable(keys) {
    const tbody = document.querySelector("#keysTable tbody");
    tbody.innerHTML = "";

    keys.forEach(k => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
            <td>${k.erp_id || "-"}</td>
            <td><span class="badge bg-info key-badge">${k.pass_key}</span></td>
            <td>${k.active === "yes" ? "Active" : "Disabled"}</td>
            <td>
                <button class="btn btn-sm btn-danger"
                        onclick="disableKey('${k.pass_key}')">
                        Disable
                </button>
            </td>
        `;
        tbody.appendChild(tr);
    });
}

/* ================= DISABLE KEY ================= */
async function disableKey(key) {
    if (!confirm("Disable this pass key?")) return;

    const secret = document.getElementById("adminSecret").value;

    const res = await fetch("/admin/delete-key", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
            admin_secret: secret,
            pass_key: key
        })
    });

    const data = await res.json();
    if (data.status === "success") {
        alert("Pass key disabled");
        verifyAndShowKeys();
    } else {
        alert("Error disabling key");
    }
}

/* ================= STATS ================= */
async function loadStats() {
    const secret = document.getElementById("adminSecret").value;

    const res = await fetch("/admin/stats", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ admin_secret: secret })
    });

    const data = await res.json();
    if (data.status === "success") {
        document.getElementById("total").innerText = data.total_students;
        document.getElementById("verified").innerText = data.verified;
        document.getElementById("unverified").innerText = data.unverified;
    } else {
        alert("Unauthorized");
    }
}
</script>

</body>
</html>
